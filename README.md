# è¿›ç¨‹å’Œçº¿ç¨‹

## è¿›ç¨‹å’Œçº¿ç¨‹

### è¿›ç¨‹

* ç¨‹åºç”±æŒ‡ä»¤å’Œæ•°æ®ç»„æˆï¼Œä½†è¿™äº›æŒ‡ä»¤å“Ÿå•Šè¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œå°±å¿…é¡»æŠŠæŒ‡ä»¤åŠ è½½è‡³CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜ã€‚åœ¨æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ä¸­è¿˜éœ€è¦ç”¨åˆ°ç£ç›˜ï¼Œç½‘ç»œç­‰è®¾å¤‡ã€‚è¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ï¼Œç®¡ç†å†…å­˜ï¼Œç®¡ç†IOçš„
* å½“ä¸€ä¸ªç¨‹åºè¢«è¿è¡Œï¼Œä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç è‡³å†…å­˜ï¼Œè¿™æ—¶å°±å¼€å¯äº†ä¸€ä¸ªçº¿ç¨‹
* è¿›ç¨‹å°±å¯ä»¥è§†ä¸ºç¨‹åºçš„ä¸€ä¸ªå®ä¾‹ï¼Œå¤§éƒ¨åˆ†ç¨‹åºå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹è¿›ç¨‹ï¼Œæœ‰çš„ç¨‹åºä¹Ÿåªèƒ½å¯åŠ¨ä¸€ä¸ªå®ä¾‹è¿›ç¨‹ã€‚

### çº¿ç¨‹

* ä¸€ä¸ªè¿›ç¨‹ä¹‹å†…å¯ä»¥åˆ†ä¸ºä¸€åˆ°å¤šä¸ªçº¿ç¨‹
* ä¸€ä¸ªè¿›ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµï¼Œå°†æŒ‡ä»¤æµä¸­çš„ä¸€æ¡æ¡æŒ‡ä»¤ä»¥ä¸€å®šçš„é¡ºåºäº¤ç»™CPUæ‰§è¡Œ
* Javaä¸­ï¼Œæˆçº¿ç¨‹ä½œä¸ºæœ€å°è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹ä½œä¸ºèµ„æºåˆ†é…çš„æœ€å°å•ä½ã€‚åœ¨windowsä¸­è¿›ç¨‹æ˜¯ä¸æ´»åŠ¨çš„ï¼Œåªæ˜¯ä½œä¸ºçº¿ç¨‹çš„å®¹å™¨

### å¯¹æ¯”

* è¿›ç¨‹åŸºæœ¬ä¸Šæ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œè€Œçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›†
* è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ç­‰ï¼Œä¾›å†…éƒ¨çš„çº¿ç¨‹å…±äº«
* è¿›ç¨‹é—´é€šä¿¡è¾ƒä¸ºå¤æ‚
  * åŒä¸€å°è®¡ç®—æœºçš„è¿›ç¨‹é€šä¿¡å«IPC
  * ä¸åŒè®¡ç®—æœºä¹‹é—´çš„è¿›ç¨‹é€šä¿¡ï¼Œéœ€è¦é€šè¿‡ç½‘ç»œï¼Œå¹¶éµå¾ªå…±åŒçš„åè®®
* çº¿ç¨‹é€šä¿¡ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºä»–ä»¬å…±äº«è¿›ç¨‹å†…çš„å†…å­˜ï¼Œä¸€ä¸ªä¾‹å­æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡
* çº¿ç¨‹æ›´è½»é‡ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ä¸€èˆ¬æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä½



## å¹¶è¡Œä¸å¹¶å‘

å•æ ¸cpuä¸‹ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯`ä¸²è¡Œæ‰§è¡Œ`çš„ã€‚æ“ä½œç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªç»„ä»¶å«åšä»»åŠ¡è°ƒåº¦å™¨ï¼Œå°†cpuçš„æ—¶é—´ç‰‡ï¼ˆwindowsä¸‹æ—¶é—´ç‰‡æœ€å°çº¦15msï¼‰åˆ†ç»™ä¸åŒçš„çº¿ç¨‹ä½¿ç”¨ï¼Œåªæ˜¯ç”±äºcpuåœ¨çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢éå¸¸å¿«ï¼Œäººç±»è§‰å¾—æ˜¯åŒæ—¶è¿è¡Œçš„ã€‚æ€»ç»“ä¸€å¥è¯**å¾®è§‚ä¸²è¡Œï¼Œå®è§‚å¹¶è¡Œ**

ä¸€èˆ¬ä¼šæŠŠè¿™ç§çº¿ç¨‹è½®æµä½¿ç”¨CPUçš„æ–¹æ³•ç§°ä¸º**å¹¶å‘ï¼Œconcurrent**

![image-20251107195334747](C:\Users\Qingfeng\AppData\Roaming\Typora\typora-user-images\image-20251107195334747.png)

å¤šæ ¸cpuä¸‹ï¼Œæ¯ä¸ªæ ¸éƒ½å¯ä»¥è°ƒåº¦è¿è¡Œçº¿ç¨‹ï¼Œè¿™æ—¶å€™çº¿ç¨‹æ˜¯å¯ä»¥**å¹¶è¡Œ**çš„ã€‚

## åº”ç”¨

### å¼‚æ­¥è°ƒç”¨

ä»æ–¹æ³•è°ƒç”¨çš„è§’åº¦æ¥è®²ï¼Œå¦‚æœ

* éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥
* ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥

æ³¨æ„ï¼šåŒæ­¥åœ¨å¤šçº¿ç¨‹ä¸­è¿˜æœ‰å¦å¤–ä¸€å±‚æ„æ€ï¼Œå°±æ˜¯è®©å¤šä¸ªçº¿ç¨‹æ­¥è°ƒä¸€è‡´

### æ•ˆç‡æå‡



# Javaçº¿ç¨‹

* åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹
* æŸ¥çœ‹çº¿ç¨‹
* çº¿ç¨‹API
* çº¿ç¨‹çŠ¶æ€

## åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹

æ–¹æ³•ä¸€ï¼Œç›´æ¥ä½¿ç”¨Thread

æ–¹æ³•äºŒï¼Œä½¿ç”¨RunnableèåˆThread

æ–¹æ³•ä¸‰ï¼ŒFutureTaské…åˆThread



## è§‚å¯Ÿå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ



## æŸ¥çœ‹çº¿ç¨‹è¿›ç¨‹çš„æ–¹æ³•

* tasklist



## åŸç†ä¹‹çº¿ç¨‹è¿è¡Œ

### æ ˆä¸æ ˆå¸§

### çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆThread Context Switchï¼‰

å› ä¸ºä»¥ä¸‹åŸå› å¯¼è‡´cpuä¸å†æ‰§è¡Œå½“å‰çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç 

* çº¿ç¨‹çš„cpuæ—¶é—´ç‰‡ç”¨å®Œ
* åƒåœ¾å›æ”¶
* æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ
* çº¿ç¨‹è‡ªå·±è°ƒç”¨äº†sleep,yield,wait,join,park,synchronized,lockç­‰æ–¹æ³•

å½“ä¸Šä¸‹æ–‡åˆ‡æ¢å‘ç”Ÿæ—¶ï¼Œéœ€è¦æœ‰æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼ŒJavaä¸­å¯¹åº”çš„æ¦‚å¿µå°±æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼Œä½œç”¨æ˜¯è®°ä½ä¸‹ä¸€æ¡jvmå‘½ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„

* çŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ï¼Œæ ˆå¸§ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ï¼Œæ“ä½œæ•°æ ˆè¿”å›åœ°å€ç­‰
* é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šå½±å“æ€§èƒ½

## å¸¸è§æ–¹æ³•

* startï¼šå¯åŠ¨çº¿ç¨‹ï¼Œè®©çº¿ç¨‹å°±ç»ª
  * é‡Œé¢çš„ä»£ç ä¸ä¸€å®šç«‹åˆ»è¿è¡Œï¼ˆcpuçš„æ—¶é—´ç‰‡è¿˜æ²¡åˆ†ç»™ä»–ï¼‰ï¼Œåªèƒ½è°ƒç”¨ä¸€æ¬¡
* runï¼šçº¿ç¨‹å¯åŠ¨åè¿è¡Œçš„æ–¹æ³•
* joinï¼šç­‰å¾…çº¿ç¨‹è¿è¡Œç»“æŸ
* setï¼Œgetæ–¹æ³•
* sleepï¼šä¼‘çœ 
* yieldï¼šç¤¼è®©

### startä¸run

è°ƒç”¨startä¼šæŠŠå½“å‰çº¿ç¨‹ä»`NEW`çŠ¶æ€è¿›å…¥`RUNNABLE`çŠ¶æ€

### sleepä¸yield

#### sleep

1. è°ƒç”¨sleepä¼šè®©å½“å‰çº¿ç¨‹ä»`RUNNABLE`è¿›å…¥`TIMED_WAITING`çŠ¶æ€
2. å…¶ä»–çº¿ç¨‹å¯ä»¥ä½¿ç”¨`interrupt`æ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶sleepæ–¹æ³•ä¼šæŠ›å‡º`InterruptedException`
3. ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œ
4. å»ºè®®ç”¨`TimeUnit`çš„sleepä»£æ›¿Threadçš„sleepæ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§

#### yield

1. è°ƒç”¨yieldä¼šè®©å½“å‰çº¿ç¨‹ä»`RUNNING`è¿›å…¥`RUNNABLE`å°±ç»ªçŠ¶æ€ï¼Œç„¶åè°ƒåº¦å…¶å®ƒ2åŒä¼˜å…ˆçº§çš„çº¿ç¨‹ã€‚å¦‚æœè¿™æ—¶æ²¡æœ‰åŒä¼˜å…ˆçº§çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆä¸èƒ½ä¿è¯è®©å½“å‰çº¿ç¨‹æš‚åœçš„æ•ˆæœ
2. å…·ä½“çš„å®ç°ä¾èµ–äºosçš„ä»»åŠ¡è°ƒåº¦å™¨

#### çº¿ç¨‹ä¼˜å…ˆçº§

* çº¿ç¨‹ä¼˜å…ˆçº§ä¼šæç¤ºï¼ˆhintï¼‰è°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œä½†å®ƒä»…ä»…æ˜¯ä¸€ä¸ªæç¤ºï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒ
* å¦‚æœcpuæ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½†cpué—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ç”¨ã€‚

### join

ç­‰å¾…æŸä¸ªçº¿ç¨‹è¿è¡Œç»“æŸ

### interrput

#### æ‰“æ–­sleepï¼Œwaitï¼Œjoin

è¿™ä¸‰ä¸ªè¢«æ‰“æ–­ä¹‹åï¼Œä¼šæ¸…é™¤æ ‡è®°ï¼Œå¯¼è‡´è°ƒç”¨`isInterrupted()`æ–¹æ³•ï¼Œä¼šè¾“å‡ºfalse

#### æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹

#### ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼

**åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä¼˜é›…åœ°ç»ˆæ­¢å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œä¼˜é›…æŒ‡çš„æ˜¯ç»™è¢«ä¸­æ­¢çš„çº¿ç¨‹ä¸€ä¸ªåŠç†åäº‹çš„æœºä¼š**

#### æ‰“æ–­parkçº¿ç¨‹

## ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹

ä¸»çº¿ç¨‹ç»“æŸåï¼Œå®ˆæŠ¤çº¿ç¨‹ä¼šè¢«è¿«ç»“æŸ

## äº”ç§çŠ¶æ€

ä»**æ“ä½œç³»ç»Ÿ**å±‚é¢æ¥æè¿°çš„

![image-20251108155307957](C:\Users\Qingfeng\AppData\Roaming\Typora\typora-user-images\image-20251108155307957.png)

## å…­ç§çŠ¶æ€

ä»**Java API**å±‚é¢æ¥æè¿°çš„

![image-20251108155403421](C:\Users\Qingfeng\AppData\Roaming\Typora\typora-user-images\image-20251108155403421.png)

16:14:18.757 [main] DEBUG TestState -- t1 state NEW
16:14:18.758 [main] DEBUG TestState -- t2 state RUNNABLE
16:14:18.758 [main] DEBUG TestState -- t3 state TERMINATED
16:14:18.758 [main] DEBUG TestState -- t4 state TIMED_WAITING
16:14:18.758 [main] DEBUG TestState -- t5 state WAITING
16:14:18.758 [main] DEBUG TestState -- t6 state BLOCKED

```java
import lombok.extern.slf4j.Slf4j;

@Slf4j
public class TestState {
    public static void main(String[] args) {
        Thread t1 = new Thread("t1"){
            @Override
            public void run() {
                log.debug("running...");
            }
        };

        Thread t2 = new Thread("t2"){
            @Override
            public void run() {
                while (true){

                }
            }
        };
        t2.start();

        Thread t3 = new Thread("t3"){
            @Override
            public void run() {
                log.debug("running...");
            }
        };
        t3.start();

        Thread t4 = new Thread("t4"){
            @Override
            public void run() {
                synchronized (TestState.class){
                    try {
                        Thread.sleep(10000000);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            }
        };
        t4.start();

        Thread t5 = new Thread("t5"){
            @Override
            public void run() {
                try {
                    t2.join();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        };
        t5.start();

        Thread t6 = new Thread("t6"){
            @Override
            public void run() {
                synchronized (TestState.class){
                    try {
                        Thread.sleep(1000000);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            }
        };
        t6.start();

        try {
            Thread.sleep(500);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        log.debug("t1 state {}",t1.getState());
        log.debug("t2 state {}",t2.getState());
        log.debug("t3 state {}",t3.getState());
        log.debug("t4 state {}",t4.getState());
        log.debug("t5 state {}",t5.getState());
        log.debug("t6 state {}",t6.getState());
    }
}

```

# å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹

## å…±äº«é—®é¢˜

### é—®é¢˜åˆ†æ

åŸå­æ€§æ— æ³•å¾—åˆ°ä¿è¯ï¼Œå¯¼è‡´æ•°æ®è„å†™è„è¯»

### ä¸´ç•ŒåŒº Critical Section

* ä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„
* é—®é¢˜å‡ºç°åœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®**å…±äº«èµ„æº**
  * å¤šä¸ªçº¿ç¨‹**è¯»**å…±äº«èµ„æºä¹Ÿæ²¡é—®é¢˜
  * åœ¨å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºè¯»å†™æ“ä½œæ—¶å‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜
* ä¸€æ®µä»£ç å—å¦‚æœå­˜åœ¨å¯¹**å…±äº«èµ„æº**çš„å¤šçº¿ç¨‹è¯»å†™æ“ä½œï¼Œå°±ç§°è¿™æ®µä»£ç ä¸º**ä¸´ç•ŒåŒº**

## synchronized

### åº”ç”¨ä¹‹äº’æ–¥

ä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼Œæœ‰å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°ç›®çš„ã€‚

* é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼ŒLock
* éé˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡

synchronizedï¼Œä¿—ç§°**ã€å¯¹è±¡é”ã€‘**ï¼Œé‡‡ç”¨äº’æ–¥çš„æ–¹å¼è®©åŒä¸€æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰å¯¹è±¡é”ï¼Œå…¶ä»–çº¿ç¨‹åœ¨æƒ³è·å–è¿™ä¸ªå¯¹è±¡é”å°±ä¼šè¢«é˜»å¡ä½ã€‚è¿™æ ·å°±èƒ½ä¿è¯ç”¨æœ‰é”çš„çº¿ç¨‹å¯ä»¥å®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒºå†…çš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢

**è¦ç”¨åŒä¸€æŠŠé”ï¼Œå¦åˆ™å’Œæ²¡åŠ é”æ²¡åŒºåˆ«**

### é”çš„ä½ç½®

`public synchronized void a()`ï¼Œé”ä½çš„æ˜¯`this`å¯¹è±¡ï¼Œå³è°ƒç”¨è€…æœ¬èº«

`public static synchronized void a()`ï¼Œé”ä½çš„æ˜¯ç±»çš„ç±»å¯¹è±¡`Myclass.class`

## çº¿ç¨‹å®‰å…¨åˆ†æ

### æˆå‘˜å˜é‡å’Œé™æ€å˜é‡

* å¦‚æœå®ƒä»¬æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨
* å¦‚æœå®ƒä»¬è¢«å…±äº«äº†ï¼Œæ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½å¤Ÿæ”¹å˜ï¼Œåˆåˆ†ä¸¤ç§æƒ…å†µ
  * å¦‚æœåªæœ‰è¯»æ“ä½œï¼Œåˆ™çº¿ç¨‹å®‰å…¨
  * å¦‚æœæœ‰è¯»å†™æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨

### å±€éƒ¨å˜é‡

* å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„
* ä½†å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡æœªå¿…
  * å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„
  * å¦‚æœè¯¥å¯¹è±¡é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œåˆ™éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨

### æˆå‘˜å˜é‡

åˆ›å»ºä¸€ä¸ªè¯¥ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨å®ä¾‹å¯¹è±¡çš„method1æ–¹æ³•é‡å†™å¤šä¸ªçº¿ç¨‹çš„runæ–¹æ³•æ—¶ï¼Œç”±äº`add`æ–¹æ³•ä¸æ˜¯åŸå­æ€§çš„ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜å‘ç”Ÿ

```java
class ThreadUnsafe{
    ArrayList<String> list = new ArrayList<>();
    public void method1(int loopNumber){
        for (int i = 0; i < loopNumber; i++) {
            method2();
            method3();
        }
    }

    private void method2() {
        list.add("1");
    }

    private void method3() {
        list.remove(0);
    }
}
```

### å¸¸è§çº¿ç¨‹å®‰å…¨ç±»

* String
* Integer
* StringBuffer
* Random
* Vector
* Hashtable
* java.util.concurrentåŒ…ä¸‹çš„ç±»

è¯´å®ƒä»¬çº¿ç¨‹å®‰å…¨æŒ‡çš„æ˜¯ï¼Œå¤šä¸ªçº¿ç¨‹è°ƒç”¨å®ƒä»¬åŒä¸€ä¸ªå®ä¾‹çš„æŸä¸ªæ–¹æ³•æ—¶ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä¹Ÿå¯ä»¥ç†è§£ä¸ºï¼š

* å®ƒä»¬çš„æ¯ä¸ªæ–¹æ³•æ˜¯åŸå­çš„
* ä½†**æ³¨æ„**å®ƒä»¬å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­çš„

![image-20251108200555341](C:\Users\Qingfeng\AppData\Roaming\Typora\typora-user-images\image-20251108200555341.png)

## Monitor

### Javaå¯¹è±¡å¤´

![image-20251109142606494](C:\Users\Qingfeng\AppData\Roaming\Typora\typora-user-images\image-20251109142606494.png)

### Monitor

Monitorè¢«ç¿»è¯‘ä¸º**ç›‘è§†å™¨**æˆ–**ç®¡ç¨‹**

æ¯ä¸ªJavaå¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ªMonitorå¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨synchronizedç»™å¯¹è±¡åŠ ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡çš„Mark Wordä¸­å°±è¢«è®¾ç½®æŒ‡å‘Monitorå¯¹è±¡çš„æŒ‡é’ˆ

Monitorå¯¹è±¡ç»“æ„

![image-20251109143818115](C:\Users\Qingfeng\AppData\Roaming\Typora\typora-user-images\image-20251109143818115.png)

* åˆšå¼€å§‹Monitorä¸­Ownerä¸ºnull
* å½“Thread-2æ‰§è¡Œsynchronizedåï¼Œmointorä¸­çš„ownerå˜æˆThread-2ï¼Œowneråªèƒ½æœ‰ä¸€ä¸ª
* å…¶ä»–çº¿ç¨‹æ‰§è¡Œåˆ°synchronizedï¼Œå‘ç°ownerä¸­å·²ç»æœ‰äº†çº¿ç¨‹ï¼Œå°±ä¼šè¿›å…¥EntryListè¢«é˜»å¡
* ä»è€Œä¿è¯äº†å¤šçº¿ç¨‹å¹¶å‘æƒ…å†µä¸‹çš„åŸå­æ€§æ“ä½œ

## synchronizedåŸç†è¿›é˜¶

### è½»é‡çº§é”

è½»é‡çº§é”çš„ä½¿ç”¨åœºæ™¯ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šçº¿ç¨‹è®¿é—®ï¼Œä½†å¤šçº¿ç¨‹è®¿é—®çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ç«äº‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ã€‚

è½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼Œå³è¯­æ³•ä»ç„¶æ˜¯synchronized

å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡æ·é”

```java
static final Object obj = new Object();
public static void method1(){
    synchronized(obj){
        // åŒæ­¥å—A
        method2();
    }
}

public static void method2(){
    synchronized(obj){
        // åŒæ­¥å—B
    }
}
```



### é”è†¨èƒ€



### è‡ªæ—‹ä¼˜åŒ–

é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™æŒé”çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡



### åå‘é”

#### åå‘çŠ¶æ€

**å¯¹è±¡å¤´æ ¼å¼**

![image-20251110094617434](C:\Users\Qingfeng\AppData\Roaming\Typora\typora-user-images\image-20251110094617434.png)

ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š

* å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkwordå€¼ä¸º0x05å³æœ€åä¸‰ä½ä¸º101ï¼Œè¿™æ—¶å®ƒçš„threadï¼Œepochï¼Œageéƒ½ä¸º0
* åå‘é”æ˜¯é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ VMå‚æ•°æ¥é¿å…å»¶è¿Ÿ
* å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkwordå€¼ä¸º0x01å³æœ€åä¸‰ä½ä¸º001ï¼Œè¿™æ—¶å®ƒçš„hashcodeï¼Œageéƒ½ä¸º0ï¼Œç¬¬ä¸€æ¬¡ç”¨åˆ°hashcodeæ—¶æ‰ä¼šèµ‹å€¼

#### æ’¤é”€-è°ƒç”¨å¯¹è±¡hashCode

è°ƒç”¨äº†å¯¹è±¡çš„hashCodeï¼Œä½†åå‘é”çš„å¯¹è±¡MarkWordä¸­å­˜å‚¨çš„æ˜¯çº¿ç¨‹idï¼Œå¦‚æœè°ƒç”¨hashCodeä¼šå¯¼è‡´åå‘é”è¢«æ’¤é”€

* è½»é‡çº§é”ä¼šåœ¨é”è®°å½•ä¸­è®°å½•hashCode
* é‡é‡çº§é”ä¼šåœ¨Monitorä¸­è®°å½•hashCode

#### æ’¤é”€-å…¶å®ƒçº¿ç¨‹ä½¿ç”¨å¯¹è±¡

å½“æœ‰å…¶å®ƒçº¿ç¨‹ä½¿ç”¨åå‘é”å¯¹è±¡æ—¶ï¼Œä¼šå°†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”

#### æ‰¹é‡é‡åå‘

å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ²¡æœ‰ç«äº‰ï¼Œè¿™æ—¶åå‘äº†çº¿ç¨‹t1çš„å¯¹è±¡ä»ç„¶æœ‰æœºä¼šé‡æ–°åå‘t2ï¼Œå†²åå‘ä¼šé‡ç½®å¯¹è±¡çš„ThreadID

å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡20æ¬¡åï¼Œjvmä¼šè¿™æ ·è§‰å¾—ï¼Œæˆ‘æ˜¯ä¸æ˜¯åå‘é”™äº†å‘¢ï¼Œäºæ˜¯ä¼šåœ¨ç»™è¿™äº›å¯¹è±¡åŠ é”æ—¶é‡æ–°åå‘è‡³åŠ é”çº¿ç¨‹

#### æ‰¹é‡æ’¤é”€

å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡40æ¬¡åï¼Œjvmè¿˜ä¼šè¿™æ ·è§‰å¾—ï¼Œè‡ªå·±ç¡®å®åå‘é”™äº†ï¼Œæ ¹æœ¬å°±ä¸è¯¥åå‘ã€‚äºæ˜¯æ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šå˜æˆä¸å¯åå‘çš„ï¼Œæ–°å»ºçš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯åå‘çš„ã€‚

### é”æ¶ˆé™¤

JITå¯¹çƒ­ç‚¹ä»£ç å—å»é”

## wait notify

### ä¸ºä»€ä¹ˆéœ€è¦wait

![image-20251110105605958](C:\Users\Qingfeng\AppData\Roaming\Typora\typora-user-images\image-20251110105605958.png)

![image-20251110105639204](C:\Users\Qingfeng\AppData\Roaming\Typora\typora-user-images\image-20251110105639204.png)

**å¤§è‡´ç†è§£ï¼š**

æ­£åœ¨å·¥ä½œçš„çº¿ç¨‹éœ€è¦é¢å¤–çš„ä¸œè¥¿æ¥ä¼‘æ¯ï¼Œä½†æ— æ³•è·å¾—ï¼Œä¼šè°ƒç”¨waitæ–¹æ³•ä»Ownerè¿›å…¥WaitSetï¼Œæ­¤æ—¶è¢«é˜»å¡çš„çº¿ç¨‹ä¼šäº‰æŠ¢è¿›å…¥Ownerï¼Œå¹¶ç»™åœ¨WaitSeté‡Œä¼‘æ¯çš„çº¿ç¨‹é€’çƒŸï¼ˆnotifyï¼‰ï¼Œä¹‹åä¾¿ç¦»å¼€ä¼‘æ¯å®¤ï¼Œé‡æ–°è¿›å…¥ç«äº‰é˜Ÿåˆ—

### åŸç†

![image-20251110110307399](C:\Users\Qingfeng\AppData\Roaming\Typora\typora-user-images\image-20251110110307399.png)

* Ownerçº¿ç¨‹å‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨waitæ–¹æ³•ï¼Œå³å¯è®¡å…¥WaitSetå˜ä¸ºWAITINGçŠ¶æ€
* BLOCKEDå’ŒWAITINGçš„çº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å ç”¨CPUæ—¶é—´ç‰‡
* BLOCKEDçº¿ç¨‹ä¼šåœ¨Ownerçº¿ç¨‹é‡Šæ”¾é”æ—¶å”¤é†’
* WAITINGçº¿ç¨‹ä¼šåœ¨Ownerçº¿ç¨‹è°ƒç”¨notifyæˆ–notifyAllæ—¶å”¤é†’ï¼Œä½†å”¤é†’åå¹¶ä¸æ„å‘³ç€ç«‹åˆ»è·å¾—é”ï¼Œä»éœ€è¿›å…¥EntryListé‡æ–°ç«äº‰



### APIä»‹ç»

* obj.wait()è®©è¿›å…¥objç›‘è§†å™¨çš„çº¿ç¨‹åˆ°waitSetç­‰å¾…
* obj.notify()åœ¨objä¸Šæ­£åœ¨waitSetç­‰å¾…çš„çº¿ç¨‹æŒ‘ä¸€ä¸ªå”¤é†’
* obj.notifyAll()è®©objä¸Šæ­£åœ¨waitSetç­‰å¾…çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’

å®ƒä»¬éƒ½æ˜¯çº¿ç¨‹ä¹‹é—´è¿›è¡Œåä½œçš„æ‰‹æ®µï¼Œéƒ½å±äºObjectå¯¹è±¡çš„æ–¹æ³•ï¼Œå¿…é¡»è·å¾—æ­¤å¯¹è±¡çš„é”ï¼Œæ‰èƒ½è°ƒç”¨è¿™å‡ ä¸ªæ–¹æ³•

### æ­£ç¡®ç”¨æ³•

**sleepå’Œwaitæ–¹æ³•çš„åŒºåˆ«**

* sleepæ˜¯Threadæ–¹æ³•ï¼Œè€Œwaitæ˜¯Objectçš„æ–¹æ³•
* sleepä¸éœ€è¦å¼ºåˆ¶å’Œsynchronizedé…åˆä½¿ç”¨ï¼Œä½†waitéœ€è¦å’Œsynchronizedä¸€èµ·ç”¨
* sleepåœ¨ä¼‘çœ çš„åŒæ—¶ï¼Œä¸ä¼šé‡Šæ”¾å¯¹è±¡é”ï¼Œä½†waitåœ¨ç­‰å¾…çš„æ—¶å€™ä¼šé‡Šæ”¾å¯¹è±¡é”

```java
synchronized(lock){
    while(æ¡ä»¶ä¸æˆç«‹){
        lock.wait();
    }
    
    // do something
}

// å¦ä¸€ä¸ªçº¿ç¨‹notifyAll()
synchronized(lock){
    lock.notifyAll();
}
```

## åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ

### å®šä¹‰

å®šä¹‰ï¼šGuarded Suspensionï¼Œç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœ

* æœ‰ä¸€ä¸ªç»“æœåœ¨çº¿ç¨‹é—´ä¼ é€’ï¼Œè®©ä»–ä»¬å…³è”åŒä¸€ä¸ªGuardedObject
* å¦‚æœéœ€è¦ä¸æ–­ä¼ é€’ï¼Œå¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—
* JDKä¸­ï¼Œjoinï¼ŒFutureçš„å®ç°ï¼Œé‡‡ç”¨çš„å°±æ˜¯æ­¤æ¨¡å¼
* å› ä¸ºéœ€è¦ç­‰å¾…å¦ä¸€æ–¹çš„ç»“æœï¼Œå½’ç±»åˆ°åŒæ­¥æ¨¡å¼

### åŸç†ä¹‹join

### æ‰©å±•ç‚¹

å¦‚æœéœ€è¦åœ¨å¤šä¸ªç±»ä¹‹é—´ä½¿ç”¨GuardedObjectå¯¹è±¡ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œå› æ­¤è®¾è®¡ä¸€ä¸ªç”¨æ¥è§£è€¦çš„ä¸­é—´ç±»ï¼Œä¸ä»…èƒ½è§£è€¦ç­‰å¾…è€…å’Œç”Ÿäº§è€…ï¼Œè¿˜èƒ½åŒæ—¶æ”¯æŒå¤šä¸ªä»»åŠ¡çš„ç®¡ç†

![image-20251110170332434](C:\Users\Qingfeng\AppData\Roaming\Typora\typora-user-images\image-20251110170332434.png)

## åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶



## å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…/æ¶ˆè´¹è€…

* ä¸ä¹‹å‰çš„ä¿æŠ¤æ€§æš‚åœä¸­çš„GuardedObjectä¸åŒï¼Œä¸éœ€è¦äº§ç”Ÿç»“æœå’Œæ¶ˆè´¹ç»“æœçš„çº¿ç¨‹ä¸€ä¸€å¯¹åº”
* æ¶ˆè´¹é˜Ÿåˆ—å¯ä»¥ç”¨æ¥å¹³è¡¡ç”Ÿäº§å’Œæ¶ˆè´¹çš„çº¿ç¨‹èµ„æº
* ç”Ÿäº§è€…ä»…è´Ÿè´£äº§ç”Ÿç»“æœæ•°æ®ï¼Œä¸ç®¡æ–°æ•°æ®è¯¥å¦‚ä½•å¤„ç†ï¼Œè€Œæ¶ˆè´¹è€…ä¸“å¿ƒå¤„ç†ç»“æœæ•°æ®
* æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æœ‰å®¹é‡é™åˆ¶çš„ã€‚æ»¡æ—¶ä¸ä¼šå†åŠ å…¥æ•°æ®ï¼Œç©ºæ—¶ä¸ä¼šå†æ¶ˆè€—æ•°æ®
* JDKä¸­å„ç§é˜»å¡é˜Ÿåˆ—ï¼Œé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼

**ä»£ç å®ç°**

```java
class MessageQueue{
    // åŒå‘é“¾è¡¨æ¥å­˜å‚¨
    private LinkedList<Message> list = new LinkedList<>();
    // é˜Ÿåˆ—å®¹é‡
    private int capacity;

    public MessageQueue(int capacity){
        this.capacity = capacity;
    }

    // è·å–æ¶ˆæ¯
    public Message take(){
        // ç›‘å¯Ÿå¯¹è±¡æ˜¯å¦ä¸ºç©º
        synchronized (list){
            while(list.isEmpty()){
                try {
                    log.debug("Consumer is waiting.");
                    list.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            // ä»é˜Ÿåˆ—å¤´éƒ¨è·å–æ¶ˆæ¯è¿”å›
            Message message = list.removeFirst();
            log.debug("å·²æ¶ˆè´¹æ¶ˆæ¯ -> {}",message);
            list.notifyAll();
            return message;
        }
    }

    // å­˜å…¥æ¶ˆæ¯
    public void put(Message message){
        // é˜Ÿåˆ—å°¾éƒ¨æ”¾å…¥
        synchronized (list){
            while(list.size() == capacity){
                try {
                    log.debug("Queue is already full.");
                    list.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            // åœ¨å°¾éƒ¨åŠ å…¥æ¶ˆæ¯
            list.addLast(message);
            log.debug("å·²ç”Ÿäº§æ¶ˆæ¯ -> {}",message);
            list.notifyAll();
        }
    }
}
```



## Park & Unpark

### åŸºæœ¬ä½¿ç”¨

å®ƒä»¬æ˜¯LockSupportç±»ä¸­çš„æ–¹æ³•

```java
// æš‚åœå½“å‰çº¿ç¨‹
LockSupport.park();

// æ¢å¤æŸä¸ªçº¿ç¨‹çš„è¿è¡Œ
LockSupprot.unpark();
```

```java
Thread t1 = new Thread(()->{
    log.debug("start...");
    try {
        Thread.sleep(1000);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    log.debug("park...");
    LockSupport.park();
    log.debug("resume...");
},"t1");
t1.start();

Thread.sleep(2000);
log.debug("unpark...");
LockSupport.unpark(t1);
```

### ç‰¹ç‚¹

ä¸Objectçš„wait&notifyç›¸æ¯”

* waitï¼Œnotifyå’ŒnotifyAllå¿…é¡»é…åˆObject Monitorä¸€èµ·ä½¿ç”¨ï¼Œè€Œparkå’Œunparkä¸ç”¨
* park&unparkæ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½æ¥ã€é˜»å¡ã€‘å’Œã€å”¤é†’ã€‘çš„ï¼Œè€Œnotifyåªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ŒnotifyAllæ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œä¸æ˜¯å¾ˆã€ç²¾ç¡®ã€‘
* park&unparkå¯ä»¥å…ˆunparkï¼Œè€Œwait&notifyåˆ™ä¸å¯ä»¥å…ˆnotify

### åŸç†ä¹‹park&unpark

æ¯ä¸ªçº¿ç¨‹éƒ½éšå«ç€ä¸€ä¸ª â€œè®¸å¯ï¼ˆpermitï¼‰â€ æ ‡å¿—ï¼Œåˆå§‹ä¸º **0**ã€‚

- **`unpark(thread)`**ï¼šç»™ç›®æ ‡çº¿ç¨‹å‘æ”¾ä¸€ä¸ªã€Œè®¸å¯ã€ï¼Œå³ä»¤ permit = 1ã€‚
  å¦‚æœæ­¤æ—¶çº¿ç¨‹æœªè¢«é˜»å¡ï¼Œè®¸å¯ä¼šâ€œè®°ä¸‹æ¥â€ã€‚
- **`park()`**ï¼šå¦‚æœçº¿ç¨‹è°ƒç”¨ `park()`ï¼š
  - è‹¥ permit = 1ï¼Œç«‹å³æ¶ˆè€—æ‰è¿™ä¸ªè®¸å¯ï¼ˆpermit å˜å› 0ï¼‰ï¼Œçº¿ç¨‹ **ä¸ä¼šé˜»å¡**ã€‚
  - è‹¥ permit = 0ï¼Œçº¿ç¨‹ä¼š **æŒ‚èµ·**ï¼Œç›´åˆ°è¢« `unpark()` å”¤é†’ã€‚

ğŸ‘‰ å› æ­¤ï¼š

- `park()` ä¸ `unpark()` çš„è°ƒç”¨**é¡ºåºæ— å…³**ï¼Œå³å¯ä»¥å…ˆ `unpark()` å† `park()`ã€‚
- å”¤é†’ä¿¡å·**ä¸ä¼šä¸¢å¤±**ï¼ˆä¸åƒ `wait/notify` é‚£æ ·ä¸¢å¤±é€šçŸ¥ï¼‰ã€‚



## é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢

![image-20251111204901027](C:\Users\Qingfeng\AppData\Roaming\Typora\typora-user-images\image-20251111204901027.png)

å‡è®¾æœ‰çº¿ç¨‹t

### NEW-->RUNNABLE

* å½“è°ƒç”¨`t.start()`æ–¹æ³•

### RUNNABLE<-->WAITING

#### æƒ…å†µä¸€

tçº¿ç¨‹ä½¿ç”¨synchronized(obj)è·å–äº†å¯¹è±¡é”ä¹‹åï¼Œ

* è°ƒç”¨`obj.wait()`æ–¹æ³•æ—¶ï¼Œ`RUNNABLE-->WAITING`
* è°ƒç”¨`obj.notifyAll(),obj.notify(),t.interrupt()`æ—¶ï¼Œ
  * ç«äº‰é”æˆåŠŸï¼Œ`WAITING-->RUNNABLE`
  * ç«äº‰é”å¤±è´¥ï¼Œ`WAITING-->BLOCKED`

#### æƒ…å†µäºŒ

* **å½“å‰çº¿ç¨‹now**è°ƒç”¨`t.join()`æ–¹æ³•æ—¶ï¼Œnowä»RUNNABLE-->WAITING
  * nowçº¿ç¨‹ä¼šåœ¨tçº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…
* tçº¿ç¨‹è¿è¡Œç»“æŸï¼Œæˆ–è°ƒç”¨äº†å½“å‰çº¿ç¨‹nowçš„`interrupt()`æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»WAITING-->RUNNABLE

#### æƒ…å†µä¸‰

* å½“å‰çº¿ç¨‹è°ƒç”¨`LockSupport.park()`
* è°ƒç”¨`LockSupport.unpark(ç›®æ ‡çº¿ç¨‹)`æˆ–è°ƒç”¨äº†çº¿ç¨‹çš„`interrupt()`

### RUNNABLE<-->TIMED_WAITING![image-20251111210418141](C:\Users\Qingfeng\AppData\Roaming\Typora\typora-user-images\image-20251111210418141.png)

![image-20251111210523019](C:\Users\Qingfeng\AppData\Roaming\Typora\typora-user-images\image-20251111210523019.png)

## å¤šæŠŠé”

è¿™ä¸¤ä¸ªåŠŸèƒ½äº’ä¸ç›¸å¹²ï¼Œé”`this`ç»†ç²’åº¦å¤ªå¤§ï¼Œä¸èƒ½å¹¶å‘ç¼–ç¨‹

```java
public void sleep() throws InterruptedException {
    synchronized (this){
        log.debug("sleeping 2 hours...");
        Thread.sleep(2000);
    }
}

public void study() throws InterruptedException {
    synchronized (this){
        log.debug("study 1 hour...");
        Thread.sleep(1000);
    }
}
```

é‚£å°±å¯¹ä¸šåŠ¡äº’ä¸ç›¸å…³çš„æ–¹æ³•åˆ›å»ºå¤šæŠŠé”

```java
public void sleep() throws InterruptedException {
    synchronized (sleepRoom){
        log.debug("sleeping 2 hours...");
        Thread.sleep(2000);
    }
}

public void study() throws InterruptedException {
    synchronized (studyRoom){
        log.debug("study 1 hour...");
        Thread.sleep(1000);
    }
}
```

è¿™æ ·å°±èƒ½å¤Ÿå¹¶å‘æ‰§è¡Œäº†

**å°†é”çš„ç²’åº¦ç»†åˆ†**

* å¥½å¤„ï¼Œæ˜¯å¯ä»¥å¢å¼ºå¹¶å‘åº¦
* åå¤„ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œå®¹æ˜“å‘ç”Ÿæ­»é”

## æ´»è·ƒæ€§

### æ­»é”

æœ‰è¿™æ ·çš„æƒ…å†µï¼šä¸€ä¸ªå¿ç¨‹åºå“Ÿå•ŠåŒäº‹è·å–å¤šæŠŠé”ï¼Œè¿™æ—¶å°±å®¹æ˜“å‘ç”Ÿæ­»é”

t1çº¿ç¨‹è·å¾—Açš„é”ï¼Œæ¥ä¸‹æ¥æƒ³è¦è·å–Bçš„é”

t2çº¿ç¨‹è·å¾—Bçš„é”ï¼Œæ¥ä¸‹æ¥æƒ³è¦è·å–Açš„é”

```java
Object A = new Object();
Object B = new Object();
Thread t1 = new Thread(()->{
    synchronized (A){
        log.debug("lock A");
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        synchronized (B){
            log.debug("lock B");
            log.debug("æ“ä½œ...");
        }
    }
},"t1");

Thread t2 = new Thread(()->{
    synchronized (B){
        log.debug("lock B");
        try {
            Thread.sleep(500);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        synchronized (A){
            log.debug("lock A");
            log.debug("æ“ä½œ...");
        }
    }
},"t2");

t1.start();
t2.start();
```

#### å®šä½æ­»é”

* `jps`æ‹¿åˆ°è¿›ç¨‹ID ï¼Œç„¶åæ‰§è¡Œ`jstack ID`
* `jconsole`

### æ´»é”

æ´»é”å‡ºç°åœ¨ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸ

```java
import lombok.extern.slf4j.Slf4j;

@Slf4j
public class TestLiveLock {
    static volatile int count = 10;
    static final Object Lock = new Object();
    public static void main(String[] args) {
        new Thread(()->{
            // æœŸæœ›å‡åˆ°0é€€å‡ºå¾ªç¯
            while(count > 0){
                try {
                    Thread.sleep(200);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                count--;
                log.debug("count:{}",count);
            }
        },"t1").start();

        new Thread(()->{
            // æœŸæœ›å‡åˆ°0é€€å‡ºå¾ªç¯
            while(count < 20){
                try {
                    Thread.sleep(200);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                count++;
                log.debug("count:{}",count);
            }
        },"t2").start();
    }
}
```

### é¥¥é¥¿

ä¸€ä¸ªé¡ºåºåŠ é”å¯¹æ­»é”çš„è§£å†³æ–¹æ¡ˆ

```mermaid
sequenceDiagram
participant t1 as çº¿ç¨‹1
participant t2 as çº¿ç¨‹2
participant a  as å¯¹è±¡A
participant b as å¯¹è±¡B
       t1 -->> a :å°è¯•è·å–é”
       Note over t1,a:æ‹¥æœ‰é”
       t2 -->> b :å°è¯•è·å–é”
       Note over t2,b:æ‹¥æœ‰é”
       t1 --x b : å°è¯•è·å–é”
       t2 --x a : å°è¯•è·å–é”
```

é¡ºåºåŠ é”çš„è§£å†³æ–¹æ¡ˆ

```mermaid
sequenceDiagram
participant t1 as çº¿ç¨‹1
participant t2 as çº¿ç¨‹2
participant a  as å¯¹è±¡A
participant b as å¯¹è±¡B
       t1 -->> a : å°è¯•è·å–é”
       Note over t1,a: æ‹¥æœ‰é”
       t2 --x a : å°è¯•è·å–é”
       t2 -->> a : é˜»å¡
       t1 -->> b : å°è¯•è·å–é”
       Note over t1,b: æ‹¥æœ‰é”
```

## ReentrantLock

ç›¸å¯¹äºsynchronizedå…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹ï¼š

* å¯ä¸­æ–­ï¼šå¯è°ƒç”¨æ–¹æ³•å–æ¶ˆæ‰é”
* å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼šsynchronizedè®¾ç½®çš„é”ï¼Œçº¿ç¨‹æ— æ³•è·å¾—é”ä¼šä¸€ç›´åœ¨waitSetç­‰å¾…ï¼›è€Œå¯é‡å…¥é”å¯ä»¥è®¾ç½®ç­‰å¾…æ—¶é—´ï¼Œè¶…è¿‡ç­‰å¾…æ—¶é—´è‡ªåŠ¨æ‰§è¡Œå…¶ä»–ä»»åŠ¡
* å¯ä»¥è®¾ç½®ä¸ºå…¬å¹³é”ï¼šé˜²æ­¢é¥¥é¥¿
* æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼šç›¸å½“äºæœ‰å¤šä¸ªwaitSet

ä¸synchronizedä¸€æ ·ï¼Œéƒ½æ”¯æŒå¯é‡å…¥

**åŸºæœ¬è¯­æ³•**

```java
// è·å–é”
reentrantLock.lock();
try{
	// ä¸´ç•ŒåŒº
} finally {
    // é‡Šæ”¾é”
    reentrantLock.unlock();
}
```

### å¯é‡å…¥

### å¯æ‰“æ–­

```java
Thread t1 = new Thread(()->{
    try{
        log.debug("å°è¯•è·å–é”");
        lock.lockInterruptibly();
    } catch (InterruptedException e) {
        e.printStackTrace();
        log.debug("æ²¡æœ‰è·å¾—é”ï¼Œè¿”å›");
        return;
    }

    try{
        log.debug("è·å–åˆ°é”");
    } finally {
        lock.unlock();
    }
},"t1");

lock.lock();
t1.start();

Thread.sleep(1000);
log.debug("æ‰“æ–­t1");
t1.interrupt();
```

### é”è¶…æ—¶

è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´è‡ªåŠ¨å–æ¶ˆé˜»å¡

```java
Thread t1 = new Thread(()->{
    log.debug("å°è¯•è·å¾—é”");
    try {
        if(!lock.tryLock(2, TimeUnit.SECONDS)){
            log.debug("è·å¾—é”å¤±è´¥");
            return;
        }
    } catch (InterruptedException e) {
        throw new RuntimeException(e);
    }

    try {
        log.debug("è·å¾—é”æˆåŠŸ");
    } finally {
        lock.unlock();
    }
},"t1");

lock.lock();
log.debug("è·å¾—é”æˆåŠŸ");
t1.start();
Thread.sleep(1000);
log.debug("é‡Šæ”¾é”æˆåŠŸ");
lock.unlock();
```

### å…¬å¹³é”

```java
ReentrantLock lock = new ReentrantLock(true);
```

### æ¡ä»¶å˜é‡

synchronizedä¸­ä¹Ÿæœ‰æ¡ä»¶å˜é‡ï¼Œå°±æ˜¯waitSetï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥waitSetç­‰å¾…

è€ŒReentrantLockæœ‰å¤šä¸ªæ¡ä»¶å˜é‡ 

**ä½¿ç”¨æµç¨‹**

* awaitå‰éœ€è¦è·å¾—é”
* awaitæ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”ï¼Œè¿›å…¥conditionObjectç­‰å¾…
* awaitçš„çº¿ç¨‹è¢«å”¤é†’ï¼ˆæˆ–æ‰“æ–­ï¼Œæˆ–è¶…æ—¶ï¼‰é‡æ–°ç«äº‰locké”
* ç«äº‰locké”æˆåŠŸåï¼Œä»awaitåç»§ç»­æ‰§è¡Œ

> æ›´ç»†çš„æ§åˆ¶çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’ï¼Œé˜²æ­¢è™šå‡å”¤é†’çš„å‘ç”Ÿ

## å°ç»“

* åˆ†æå¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå“ªäº›ä»£ç ç‰‡æ®µå±äºä¸´ç•ŒåŒº
* ä½¿ç”¨synchronizedäº’æ–¥è§£å†³ä¸´ç•ŒåŒºçš„çº¿ç¨‹å®‰å…¨é—®é¢˜
  * æŒæ¡synchronizedé”å¯¹è±¡è¯­æ³•
  * æŒæ¡synchronizedåŠ è½½æˆå‘˜æ–¹æ³•thiså’Œé™æ€æ–¹æ³•è¯­æ³•class
  * æŒæ¡wait notifyåŒæ­¥æ–¹æ³•
* ä½¿ç”¨lockäº’æ–¥è§£å†³ä¸´ç•ŒåŒºçš„çº¿ç¨‹å®‰å…¨é—®é¢˜
  * lockç»†èŠ‚ï¼šå¯æ‰“æ–­ï¼Œé”è¶…æ—¶ï¼Œå…¬å¹³é”ï¼Œæ¡ä»¶å˜é‡
* åˆ†æå˜é‡çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œå¸¸è§çº¿ç¨‹å®‰å…¨ç±»
* çº¿ç¨‹æ´»è·ƒæ€§é—®é¢˜ï¼šæ­»é”ï¼Œæ´»é”ï¼Œé¥¥é¥¿
* åº”ç”¨
  * äº’æ–¥ï¼šä½¿ç”¨synchronizedæˆ–Lockè¾¾åˆ°å…±äº«èµ„æºçš„äº’æ–¥æ•ˆæœ
  * åŒæ­¥ï¼šä½¿ç”¨wait/notifyæˆ–Lockçš„æ¡ä»¶å˜é‡æ¥è¾¾åˆ°çº¿ç¨‹é—´çš„é€šä¿¡æ•ˆæœ
* åŸç†
  * monitorï¼Œsynchronizedï¼Œwait/notify
  * synchronized
  * park & unpark
* æ¨¡å¼
  * åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ
  * å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…
  * åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶

# å…±äº«æ¨¡å‹ä¹‹å†…å­˜

## Javaå†…å­˜æ¨¡å‹

JMMå³Java Memory Modelï¼Œå®ƒå®šä¹‰äº†ä¸»å­˜ï¼Œå·¥ä½œå†…å­˜æŠ½è±¡æ¦‚å¿µï¼Œåº•å±‚å¯¹åº”ç€CPUå¯„å­˜å™¨ï¼Œç¼“å­˜ï¼Œç¡¬ä»¶å†…å­˜ï¼ŒCPUæŒ‡ä»¤ä¼˜åŒ–ç­‰

JMMä½“ç°åœ¨ä¸‹åˆ—ä¸‰ä¸ªæ–¹é¢ï¼š

* åŸå­æ€§
* å¯è§æ€§
* æœ‰åºæ€§

## å¯è§æ€§

åŠ `volatile`å…³é”®å­—

## åŒæ­¥æ¨¡å¼ä¹‹Balking(çŠ¹è±«æ¨¡å¼)

```java
if(starting){
    return;
}
starting = true;
```

## double-checking-lockingåŒæ£€é”dcl

## CASç‰¹ç‚¹

ç»“åˆCASå’Œvolatileå¯ä»¥å®ç°`æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºçº¿ç¨‹æ•°å°‘ï¼Œå¤šæ ¸CPUåœºæ™¯ä¸‹`ã€‚

* CASæ˜¯åŸºäºä¹è§‚é”çš„æ€æƒ³ï¼šæœ€ä¹è§‚çš„ä¼°è®¡ï¼Œä¸æ€•åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œå°±ç®—æ”¹äº†ä¹Ÿæ— å¦¨ï¼Œå¯ä»¥ä¸€ç›´é‡è¯•
* synchronizedæ˜¯åŸºäºæ‚²è§‚é”çš„æ€æƒ³ï¼šæœ€æ‚²è§‚çš„ä¼°è®¡ï¼Œæé˜²å…¶å®ƒçº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡
* CASä½“ç°çš„æ˜¯`æ— é”å¹¶å‘ï¼Œæ— é˜»å¡å¹¶å‘`
  * å› ä¸ºæ²¡æœ‰synchronizedï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œè¿™æ˜¯æé«˜æ•ˆç‡çš„å› ç´ ä¹‹ä¸€
  * ä½†å¦‚æœç«äº‰æ¿€çƒˆï¼Œå¯ä»¥æƒ³åˆ°é‡è¯•å¿…ç„¶é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šå—å½±å“

## åŸå­æ•´æ•°

```java
AtomicInteger i = new AtomicInteger(5);

System.out.println(i.incrementAndGet());
System.out.println(i.getAndIncrement());

i.updateAndGet(value->value*10);
System.out.println(i.get());
```



## ABAé—®é¢˜è§£å†³

```java
import lombok.extern.slf4j.Slf4j;
import java.util.concurrent.atomic.AtomicStampedReference;

@Slf4j
public class Test4 {
    static AtomicStampedReference<String> ref = new AtomicStampedReference<>("A",0);

    public static void main(String[] args) throws InterruptedException {
        log.debug("main start...");
        // å–å€¼
        String prev = ref.getReference();
        // è·å–ç‰ˆæœ¬å·
        int stamp = ref.getStamp();
        log.debug("{}",stamp);
        other();
        Thread.sleep(1000);
        log.debug("change A->C {}",ref.compareAndSet(ref.getReference(),"C",stamp,stamp+1));
    }

    private static void other() {
        new Thread(()->{
            int stamp = ref.getStamp();
            log.debug("change A->B {}",ref.compareAndSet(ref.getReference(),"B",stamp,stamp+1));
        },"t1").start();

        new Thread(()->{
            int stamp = ref.getStamp();
            log.debug("change B->A {}",ref.compareAndSet(ref.getReference(),"B",stamp,stamp+1));
        },"t2").start();

    }
}
```

## åŸå­æ•°ç»„

## LongAdder

`å·²ç»è·³è¿‡ï¼Œåè¾¹å›æ¥è¡¥`

## Unsafe

```java
public class TestUnsafe {
    @SneakyThrows
    public static void main(String[] args) throws NoSuchFieldException {
        Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
        theUnsafe.setAccessible(true);
        Unsafe unsafe = (Unsafe) theUnsafe.get(null);
        System.out.println(unsafe);

        // è·å–åŸŸçš„åç§»åœ°å€
        long idOffset = unsafe.objectFieldOffset(Teacher.class.getDeclaredField("id"));
        long nameOffset = unsafe.objectFieldOffset(Teacher.class.getDeclaredField("name"));

        Teacher t = new Teacher();
        // æ‰§è¡Œcasæ“ä½œ
        unsafe.compareAndSwapInt(t,idOffset,0,1);
        unsafe.compareAndSwapObject(t,nameOffset,null,"å¼ ä¸‰");

        System.out.println(t);
    }
}

@Data
class Teacher{
    volatile int id;
    volatile String name;
}
```

## äº«å…ƒæ¨¡å¼

### ç®€ä»‹

Flyweight patternå½“éœ€è¦é‡ç”¨æ•°é‡æœ‰é™çš„åŒä¸€å¯¹è±¡æ—¶

### ä½“ç°

#### åŒ…è£…ç±»

åœ¨JDKä¸­Booleanï¼ŒByteç­‰åŒ…è£…ç±»æä¾›äº†valueOfæ–¹æ³•ï¼Œä¾‹å¦‚Longçš„valueOfä¼šç¼“å­˜128-127ä¹‹é—´çš„Longå¯¹è±¡ï¼Œåœ¨è¿™ä¸ªèŒƒå›´å†…ä¼šé‡ç”¨å¯¹è±¡ï¼Œå¤§äºè¿™ä¸ªèŒƒå›´æ‰ä¼šæ–°å»ºLongå¯¹è±¡

## final

finalå˜é‡çš„èµ‹å€¼ä¹Ÿä¼šé€šè¿‡putfieldæ¥å®Œæˆï¼Œå®Œæˆåä¼šåŠ å…¥å†™å±éšœï¼Œä¿è¯å…¶å®ƒçº¿ç¨‹è¯»åˆ°æ—¶ä¸ä¼šå‡ºç°ä¸º0çš„æƒ…å†µ

# å¹¶å‘å·¥å…·

## çº¿ç¨‹æ± 

### è‡ªå®šä¹‰çº¿ç¨‹æ± 

å¤§è‡´æµç¨‹ï¼š

1. åˆ›å»ºçº¿ç¨‹æ± ï¼Œä¼ å…¥çº¿ç¨‹æ•°é‡ï¼Œè¶…æ—¶æ—¶é—´ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å®¹é‡ï¼Œæ‹’ç»ç­–ç•¥
2. mainçº¿ç¨‹æ‰§è¡Œä»»åŠ¡
3. å½“ä»»åŠ¡æ•°æ²¡æœ‰è¶…è¿‡coreSizeæ—¶ï¼Œç›´æ¥äº¤ç»™workerå¯¹è±¡æ‰§è¡Œ;å¦‚æœä»»åŠ¡è¶…è¿‡coreSizeï¼Œç›´æ¥åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—æš‚å­˜
4.  åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å·²æ»¡
   * å·²æ»¡ï¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥
   * æœªæ»¡ï¼šåŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—
